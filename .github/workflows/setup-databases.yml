name: Setup Databases on EC2

on:
  workflow_dispatch:
    inputs:
      database_choice:
        description: '데이터베이스 선택 (1: MySQL, 2: MongoDB, 3: Redis, 4: 모든 데이터베이스)'
        required: true
        default: '4'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
      password:
        description: '비밀번호'
        required: false
        default: 'password'
        type: string
      database:
        description: '데이터베이스 이름'
        required: false
        default: 'testdb'
        type: string

jobs:
  setup-databases:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Copy files to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        source: "setup-all-databases.sh,scripts/"
        target: "/home/ec2-user/"
        strip_components: 0
      
    - name: Setup databases on EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script: |
          set -e  # 스크립트에서 오류 발생 시 즉시 종료
          
          echo "🚀 데이터베이스 설정 프로세스 시작..."
          
          echo "📁 스크립트 권한 설정 중..."
          chmod +x /home/ec2-user/setup-all-databases.sh
          chmod +x /home/ec2-user/scripts/*.sh
          
          echo "🔧 데이터베이스 설정 시작..."
          cd /home/ec2-user
          
          # 사용자 입력에 따른 데이터베이스 설정 실행
          case "${{ github.event.inputs.database_choice }}" in
            "1")
              echo "🐬 MySQL 설정 중..."
              printf "%s\n%s\n%s\n" "${{ github.event.inputs.database_choice }}" "${{ github.event.inputs.password }}" "${{ github.event.inputs.database }}" | ./setup-all-databases.sh
              ;;
            "2")
              echo "🍃 MongoDB 설정 중..."
              printf "%s\n%s\n%s\n" "${{ github.event.inputs.database_choice }}" "${{ github.event.inputs.password }}" "${{ github.event.inputs.database }}" | ./setup-all-databases.sh
              ;;
            "3")
              echo "🔴 Redis 설정 중..."
              printf "%s\n" "${{ github.event.inputs.database_choice }}" | ./setup-all-databases.sh
              ;;
            "4")
              echo "🌟 모든 데이터베이스 설정 중..."
              printf "%s\n%s\n%s\n%s\n%s\n" "${{ github.event.inputs.database_choice }}" "${{ github.event.inputs.password }}" "${{ github.event.inputs.database }}" "${{ github.event.inputs.password }}" "${{ github.event.inputs.database }}" | ./setup-all-databases.sh
              ;;
          esac
          
          echo "🔍 컨테이너 상태 확인 중..."
          docker ps
          
          echo "🎉 데이터베이스 설정이 완료되었습니다!"