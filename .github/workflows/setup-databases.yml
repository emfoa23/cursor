name: Setup Databases on EC2

on:
  workflow_dispatch:
    inputs:
      database_choice:
        description: 'ë°ì´í„°ë² ì´ìŠ¤ ì„ íƒ (1: MySQL, 2: MongoDB, 3: Redis, 4: ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤)'
        required: true
        default: '4'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
      password:
        description: 'ë¹„ë°€ë²ˆí˜¸'
        required: false
        default: 'password'
        type: string
      database:
        description: 'ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„'
        required: false
        default: 'testdb'
        type: string

jobs:
  setup-databases:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Copy files to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        source: "setup-all-databases.sh,scripts/"
        target: "/home/ec2-user/"
        strip_components: 0
      
    - name: Setup databases on EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script: |
          set -e  # ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¢…ë£Œ
          
          echo "ğŸš€ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • í”„ë¡œì„¸ìŠ¤ ì‹œì‘..."
          
          echo "ğŸ“ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì • ì¤‘..."
          chmod +x /home/ec2-user/setup-all-databases.sh
          chmod +x /home/ec2-user/scripts/*.sh
          
          echo "ğŸ”§ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • ì‹œì‘..."
          cd /home/ec2-user
          
          # ì‚¬ìš©ì ì…ë ¥ì— ë”°ë¥¸ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • ì‹¤í–‰
          case "${{ github.event.inputs.database_choice }}" in
            "1")
              echo "ğŸ¬ MySQL ì„¤ì • ì¤‘..."
              printf "%s\n%s\n%s\n" "${{ github.event.inputs.database_choice }}" "${{ github.event.inputs.password }}" "${{ github.event.inputs.database }}" | ./setup-all-databases.sh
              ;;
            "2")
              echo "ğŸƒ MongoDB ì„¤ì • ì¤‘..."
              printf "%s\n%s\n%s\n" "${{ github.event.inputs.database_choice }}" "${{ github.event.inputs.password }}" "${{ github.event.inputs.database }}" | ./setup-all-databases.sh
              ;;
            "3")
              echo "ğŸ”´ Redis ì„¤ì • ì¤‘..."
              printf "%s\n" "${{ github.event.inputs.database_choice }}" | ./setup-all-databases.sh
              ;;
            "4")
              echo "ğŸŒŸ ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • ì¤‘..."
              printf "%s\n%s\n%s\n%s\n%s\n" "${{ github.event.inputs.database_choice }}" "${{ github.event.inputs.password }}" "${{ github.event.inputs.database }}" "${{ github.event.inputs.password }}" "${{ github.event.inputs.database }}" | ./setup-all-databases.sh
              ;;
          esac
          
          echo "ğŸ” ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
          docker ps
          
          echo "ğŸ‰ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"